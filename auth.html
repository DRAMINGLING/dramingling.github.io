<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«ä»½éªŒè¯ - ä¸ªäººæ–‡æ¡£åº“</title>
    <style>
        /* ä¿æŒä¹‹å‰çš„æ ·å¼ä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        .logo { 
            width: 80px; height: 80px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%; margin: 0 auto 30px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 32px; font-weight: bold;
        }
        h1 { color: #333; margin-bottom: 10px; }
        .password-input {
            width: 100%; padding: 14px 20px;
            border: 2px solid #e1e5e9; border-radius: 12px;
            font-size: 16px; margin: 20px 0;
        }
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; padding: 16px;
            width: 100%; border-radius: 12px; font-size: 16px;
            cursor: pointer; font-weight: 600;
        }
        .debug-info {
            margin-top: 20px; padding: 10px;
            background: #f5f5f5; border-radius: 8px;
            font-size: 12px; text-align: left;
            display: none; /* è°ƒè¯•æ—¶æ”¹ä¸º display: block */
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">ğŸ”’</div>
        <h1>æ–‡æ¡£åº“è®¿é—®éªŒè¯</h1>
        <p style="color: #666; margin-bottom: 20px;">è¯·è¾“å…¥è®¿é—®å¯†é’¥æŸ¥çœ‹å—ä¿æŠ¤å†…å®¹</p>
        
        <input type="password" id="password" class="password-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥" autofocus>
        <button id="submitBtn" class="submit-btn">éªŒè¯å¹¶è®¿é—®</button>
        
        <div id="error" style="color: #e74c3c; margin-top: 15px; min-height: 20px;"></div>
        
        <!-- è°ƒè¯•ä¿¡æ¯åŒºåŸŸ -->
        <div id="debugInfo" class="debug-info"></div>
    </div>

    <script>
        // ========== é…ç½®éƒ¨åˆ† ==========
        // è¯·è®¾ç½®ä½ çš„å¯†ç 
        const CORRECT_PASSWORD = '2024PersonalDocs';
        
        // æ ¹æ®ä½ çš„ GitHub Pages é…ç½®è°ƒæ•´
        const GITHUB_CONFIG = {
            // æƒ…å†µ1: ä½ çš„ä»“åº“åæ˜¯ 'personal_documents'
            basePath: '/personal_documents/',
            
            // æƒ…å†µ2: å¦‚æœä½¿ç”¨é¡¹ç›®ç«™ç‚¹ (username.github.io/repo-name)
            // å¹¶ä¸” repo-name ä¸æ˜¯ 'personal_documents'ï¼Œè¯·ä¿®æ”¹ä¸ºï¼š
            // basePath: '/repo-name/personal_documents/',
            
            // æƒ…å†µ3: ä½¿ç”¨è‡ªå®šä¹‰åŸŸå
            // basePath: '/personal_documents/', // é€šå¸¸ä¸å˜
        };

        // ========== è°ƒè¯•å‡½æ•° ==========
        function debugLog(message, data = '') {
            const debugDiv = document.getElementById('debugInfo');
            const time = new Date().toLocaleTimeString();
            const logLine = `<div>${time}: ${message} ${data}</div>`;
            debugDiv.innerHTML += logLine;
            console.log(message, data);
        }

        // ========== åˆå§‹åŒ–è°ƒè¯• ==========
        debugLog('é¡µé¢åŠ è½½å®Œæˆ');
        debugLog('å½“å‰URL:', window.location.href);
        debugLog('å½“å‰è·¯å¾„:', window.location.pathname);
        debugLog('å½“å‰origin:', window.location.origin);

        // ========== è·å–é‡å®šå‘URL ==========
        function getRedirectUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            let redirect = urlParams.get('redirect');
            
            debugLog('åŸå§‹redirectå‚æ•°:', redirect);
            
            if (!redirect) {
                // å¦‚æœæ²¡æœ‰æŒ‡å®šé‡å®šå‘ï¼Œé»˜è®¤åˆ°æ–‡æ¡£é¦–é¡µ
                redirect = GITHUB_CONFIG.basePath + 'index.html';
                debugLog('ä½¿ç”¨é»˜è®¤é‡å®šå‘:', redirect);
                return redirect;
            }
            
            // æ¸…ç†é‡å®šå‘URL
            try {
                // ç¡®ä¿é‡å®šå‘URLæ˜¯ç›¸å¯¹è·¯å¾„ä¸”ä»¥æ­£ç¡®çš„åŸºç¡€è·¯å¾„å¼€å¤´
                if (redirect.startsWith('http')) {
                    // å¦‚æœæ˜¯å®Œæ•´URLï¼Œæå–è·¯å¾„éƒ¨åˆ†
                    const urlObj = new URL(redirect);
                    redirect = urlObj.pathname + urlObj.search;
                }
                
                // ç¡®ä¿ä»¥åŸºç¡€è·¯å¾„å¼€å¤´
                if (!redirect.startsWith(GITHUB_CONFIG.basePath)) {
                    debugLog('è­¦å‘Š: é‡å®šå‘è·¯å¾„ä¸ä»¥åŸºç¡€è·¯å¾„å¼€å¤´', redirect);
                    redirect = GITHUB_CONFIG.basePath + redirect.replace(/^\//, '');
                }
                
                debugLog('å¤„ç†åçš„é‡å®šå‘è·¯å¾„:', redirect);
                return redirect;
            } catch (error) {
                debugLog('é‡å®šå‘URLè§£æé”™è¯¯:', error.message);
                return GITHUB_CONFIG.basePath + 'index.html';
            }
        }

        // ========== ç”Ÿæˆä»¤ç‰Œ ==========
        function generateToken() {
            const tokenData = {
                t: Date.now(), // æ—¶é—´æˆ³
                e: Date.now() + (2 * 60 * 60 * 1000), // 2å°æ—¶åè¿‡æœŸ
                r: Math.random().toString(36).substr(2) // éšæœºæ•°
            };
            
            // ç®€å•çš„Base64ç¼–ç 
            const tokenString = JSON.stringify(tokenData);
            const token = btoa(unescape(encodeURIComponent(tokenString)));
            
            debugLog('ç”Ÿæˆçš„ä»¤ç‰Œ:', token.substring(0, 20) + '...');
            return token;
        }

        // ========== æ‰§è¡Œé‡å®šå‘ ==========
        function redirectToProtectedPage(token) {
            const redirectUrl = getRedirectUrl();
            debugLog('æœ€ç»ˆé‡å®šå‘ç›®æ ‡:', redirectUrl);
            
            // æ„å»ºå®Œæ•´çš„URLï¼ˆå¤„ç†ç›¸å¯¹è·¯å¾„ï¼‰
            let fullUrl;
            if (redirectUrl.startsWith('/')) {
                // ç»å¯¹è·¯å¾„
                fullUrl = window.location.origin + redirectUrl;
            } else {
                // ç›¸å¯¹è·¯å¾„
                const currentPath = window.location.pathname;
                const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
                fullUrl = window.location.origin + basePath + redirectUrl;
            }
            
            // æ·»åŠ ä»¤ç‰Œå‚æ•°
            const separator = fullUrl.includes('?') ? '&' : '?';
            const finalUrl = fullUrl + separator + 'auth_token=' + encodeURIComponent(token);
            
            debugLog('æœ€ç»ˆè®¿é—®URL:', finalUrl);
            
            // å­˜å‚¨ä»¤ç‰Œåˆ°sessionStorageï¼ˆç”¨äºé¡µé¢å†…éªŒè¯ï¼‰
            sessionStorage.setItem('auth_token', token);
            sessionStorage.setItem('auth_time', Date.now().toString());
            
            // æ‰§è¡Œé‡å®šå‘
            window.location.href = finalUrl;
        }

        // ========== äº‹ä»¶å¤„ç† ==========
        document.getElementById('submitBtn').addEventListener('click', function() {
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            
            errorDiv.textContent = '';
            
            if (!password) {
                errorDiv.textContent = 'è¯·è¾“å…¥è®¿é—®å¯†é’¥';
                return;
            }
            
            if (password === CORRECT_PASSWORD) {
                debugLog('å¯†ç éªŒè¯æˆåŠŸ');
                
                // ç”Ÿæˆä»¤ç‰Œ
                const token = generateToken();
                
                // æ‰§è¡Œé‡å®šå‘
                redirectToProtectedPage(token);
            } else {
                errorDiv.textContent = 'è®¿é—®å¯†é’¥ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•';
                document.getElementById('password').focus();
                document.getElementById('password').select();
            }
        });

        // æŒ‰Enteré”®æäº¤
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('submitBtn').click();
            }
        });

        // ========== è‡ªåŠ¨æ£€æµ‹å·²ç™»å½•çŠ¶æ€ ==========
        window.addEventListener('load', function() {
            const token = sessionStorage.getItem('auth_token');
            if (token) {
                try {
                    const tokenString = decodeURIComponent(escape(atob(token)));
                    const tokenData = JSON.parse(tokenString);
                    
                    const now = Date.now();
                    if (now < tokenData.e) {
                        // ä»¤ç‰Œæœªè¿‡æœŸï¼Œç›´æ¥é‡å®šå‘
                        debugLog('æ£€æµ‹åˆ°æœ‰æ•ˆä»¤ç‰Œï¼Œè‡ªåŠ¨é‡å®šå‘');
                        redirectToProtectedPage(token);
                    } else {
                        // ä»¤ç‰Œå·²è¿‡æœŸï¼Œæ¸…é™¤
                        debugLog('ä»¤ç‰Œå·²è¿‡æœŸï¼Œæ¸…é™¤');
                        sessionStorage.removeItem('auth_token');
                        sessionStorage.removeItem('auth_time');
                    }
                } catch (error) {
                    debugLog('ä»¤ç‰Œè§£æå¤±è´¥:', error.message);
                }
            }
        });
    </script>
</body>
</html>
