<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº«ä»½éªŒè¯ - ä¸ªäººæ–‡æ¡£åº“</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .password-input {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            margin: 20px 0;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px;
            width: 100%;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .info-box {
            margin-top: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 13px;
            color: #666;
            text-align: left;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 12px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            display: none; /* è°ƒè¯•æ—¶å¯æ”¹ä¸º block */
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">ğŸ”’</div>
        <h1>æ–‡æ¡£åº“è®¿é—®éªŒè¯</h1>
        <p style="color: #666; margin-bottom: 20px;">è¯·è¾“å…¥è®¿é—®å¯†é’¥æŸ¥çœ‹å—ä¿æŠ¤å†…å®¹</p>
        
        <input type="password" id="password" class="password-input" placeholder="è¯·è¾“å…¥è®¿é—®å¯†é’¥" autofocus>
        <button id="submitBtn" class="submit-btn">éªŒè¯å¹¶è®¿é—®</button>
        
        <div id="error" style="color: #e74c3c; margin-top: 15px; min-height: 20px;"></div>
        
        <div class="info-box">
            <p><strong>è®¿é—®è¯´æ˜ï¼š</strong></p>
            <p>â€¢ é»˜è®¤è®¿é—®å¯†ç : <code>2024PersonalDocs</code></p>
            <p>â€¢ éªŒè¯æˆåŠŸåè‡ªåŠ¨è·³è½¬</p>
            <p>â€¢ ç™»å½•çŠ¶æ€æŒç»­ 2 å°æ—¶</p>
        </div>
        
        <div id="debugInfo" class="debug-info"></div>
    </div>

    <script>
        // ========== è°ƒè¯•å·¥å…· ==========
        const DEBUG = true; // è®¾ä¸º false å…³é—­è°ƒè¯•ä¿¡æ¯
        
        function debugLog(message, data = '') {
            if (!DEBUG) return;
            
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                const time = new Date().toLocaleTimeString();
                const logLine = `<div>[${time}] ${message} ${data ? JSON.stringify(data) : ''}</div>`;
                debugDiv.innerHTML += logLine;
            }
            console.log(`[Auth] ${message}`, data);
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯åŒº
        if (DEBUG) {
            document.getElementById('debugInfo').style.display = 'block';
        }
        
        // ========== é…ç½® ==========
        const CONFIG = {
            CORRECT_PASSWORD: '13574271985',
            BASE_PATH: '/personal_documents/',
            TOKEN_EXPIRE_HOURS: 2
        };
        
        // ========== åˆå§‹åŒ– ==========
        debugLog('è®¤è¯é¡µé¢åˆå§‹åŒ–');
        debugLog('å½“å‰URL:', window.location.href);
        debugLog('å½“å‰è·¯å¾„:', window.location.pathname);
        
        // ========== è·å–é‡å®šå‘å‚æ•° ==========
        function getRedirectParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const redirect = urlParams.get('redirect');
            
            if (redirect) {
                debugLog('è·å–åˆ°é‡å®šå‘å‚æ•°:', redirect);
                
                // éªŒè¯é‡å®šå‘URLçš„åˆæ³•æ€§
                try {
                    // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç¡®ä¿æ˜¯æœ‰æ•ˆçš„
                    if (!redirect.startsWith('http')) {
                        // ç¡®ä¿é‡å®šå‘è·¯å¾„åœ¨å—ä¿æŠ¤ç›®å½•ä¸‹
                        if (redirect.startsWith(CONFIG.BASE_PATH)) {
                            return redirect;
                        }
                        
                        // å¦‚æœä¸æ˜¯ä»¥åŸºç¡€è·¯å¾„å¼€å¤´ï¼Œæ·»åŠ åŸºç¡€è·¯å¾„
                        return CONFIG.BASE_PATH + redirect.replace(/^\//, '');
                    }
                    
                    // å¦‚æœæ˜¯å®Œæ•´URLï¼Œæå–è·¯å¾„éƒ¨åˆ†
                    const url = new URL(redirect);
                    if (url.pathname.startsWith(CONFIG.BASE_PATH)) {
                        return url.pathname + url.search;
                    }
                } catch (e) {
                    debugLog('é‡å®šå‘å‚æ•°è§£æå¤±è´¥:', e.message);
                }
            }
            
            // é»˜è®¤è¿”å›é¦–é¡µ
            debugLog('ä½¿ç”¨é»˜è®¤é‡å®šå‘');
            return CONFIG.BASE_PATH + 'index.html';
        }
        
        // ========== ç”Ÿæˆä»¤ç‰Œ ==========
        function generateToken(password) {
            const tokenData = {
                p: password, // ç›´æ¥å­˜å‚¨å¯†ç ï¼ˆå‰ç«¯å®‰å…¨æœ‰é™ï¼‰
                t: Date.now(),
                e: Date.now() + (CONFIG.TOKEN_EXPIRE_HOURS * 60 * 60 * 1000),
                v: '1.0'
            };
            
            const tokenString = JSON.stringify(tokenData);
            const token = btoa(unescape(encodeURIComponent(tokenString)));
            
            debugLog('ç”Ÿæˆä»¤ç‰Œ:', token.substring(0, 30) + '...');
            return token;
        }
        
        // ========== å­˜å‚¨ä»¤ç‰Œ ==========
        function storeToken(token) {
            // ä½¿ç”¨ sessionStorage å­˜å‚¨ä»¤ç‰Œ
            sessionStorage.setItem('docs_auth_token', token);
            sessionStorage.setItem('docs_auth_time', Date.now().toString());
            
            // åŒæ—¶å­˜å‚¨åˆ° localStorage ä»¥ä¾¿é¡µé¢åˆ·æ–°åä½¿ç”¨
            localStorage.setItem('docs_auth_token', token);
            localStorage.setItem('docs_auth_time', Date.now().toString());
            
            debugLog('ä»¤ç‰Œå·²å­˜å‚¨');
        }
        
        // ========== æ‰§è¡Œé‡å®šå‘ ==========
        function redirectToProtectedPage(token) {
            const redirectUrl = getRedirectParam();
            debugLog('ç›®æ ‡é¡µé¢:', redirectUrl);
            
            // æ„å»ºå®Œæ•´URL
            let fullUrl;
            if (redirectUrl.startsWith('http')) {
                fullUrl = redirectUrl;
            } else if (redirectUrl.startsWith('/')) {
                // ç»å¯¹è·¯å¾„
                fullUrl = window.location.origin + redirectUrl;
            } else {
                // ç›¸å¯¹è·¯å¾„
                const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                fullUrl = baseUrl + redirectUrl;
            }
            
            // æ·»åŠ ä»¤ç‰Œå‚æ•°
            const separator = fullUrl.includes('?') ? '&' : '?';
            const finalUrl = fullUrl + separator + 'auth_token=' + encodeURIComponent(token);
            
            debugLog('æœ€ç»ˆé‡å®šå‘URL:', finalUrl);
            debugLog('æ­£åœ¨æ‰§è¡Œé‡å®šå‘...');
            
            // å­˜å‚¨ä»¤ç‰Œ
            storeToken(token);
            
            // å»¶è¿Ÿä¸€ä¸‹ç¡®ä¿å­˜å‚¨å®Œæˆ
            setTimeout(() => {
                window.location.href = finalUrl;
            }, 100);
        }
        
        // ========== éªŒè¯å¯†ç  ==========
        function validatePassword(password) {
            return password === CONFIG.CORRECT_PASSWORD;
        }
        
        // ========== æ£€æŸ¥å·²æœ‰ä»¤ç‰Œ ==========
        function checkExistingToken() {
            debugLog('æ£€æŸ¥ç°æœ‰ä»¤ç‰Œ...');
            
            // æ£€æŸ¥ localStorage
            const localToken = localStorage.getItem('docs_auth_token');
            const localTime = localStorage.getItem('docs_auth_time');
            
            if (localToken && localTime) {
                try {
                    const tokenString = decodeURIComponent(escape(atob(localToken)));
                    const tokenData = JSON.parse(tokenString);
                    
                    const now = Date.now();
                    if (now < tokenData.e && tokenData.p === CONFIG.CORRECT_PASSWORD) {
                        debugLog('å‘ç°æœ‰æ•ˆä»¤ç‰Œï¼Œè‡ªåŠ¨é‡å®šå‘');
                        
                        // æ›´æ–° sessionStorage
                        sessionStorage.setItem('docs_auth_token', localToken);
                        sessionStorage.setItem('docs_auth_time', localTime);
                        
                        // é‡å®šå‘
                        setTimeout(() => {
                            redirectToProtectedPage(localToken);
                        }, 500);
                        
                        return true;
                    }
                } catch (e) {
                    debugLog('ä»¤ç‰ŒéªŒè¯å¤±è´¥:', e.message);
                }
            }
            
            return false;
        }
        
        // ========== é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ ==========
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('é¡µé¢DOMåŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰é”™è¯¯å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('error') === 'auth_failed') {
                document.getElementById('error').textContent = 'è®¿é—®ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯';
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æœ‰æ•ˆä»¤ç‰Œ
            if (!checkExistingToken()) {
                debugLog('æœªå‘ç°æœ‰æ•ˆä»¤ç‰Œï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥');
            }
        });
        
        // ========== è¡¨å•æäº¤å¤„ç† ==========
        document.getElementById('submitBtn').addEventListener('click', function() {
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            const button = this;
            
            // æ¸…é™¤é”™è¯¯ä¿¡æ¯
            errorDiv.textContent = '';
            
            if (!password) {
                errorDiv.textContent = 'è¯·è¾“å…¥è®¿é—®å¯†é’¥';
                return;
            }
            
            debugLog('æ­£åœ¨éªŒè¯å¯†ç ...');
            
            // éªŒè¯å¯†ç 
            if (validatePassword(password)) {
                debugLog('å¯†ç éªŒè¯æˆåŠŸ');
                
                // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
                button.disabled = true;
                button.textContent = 'éªŒè¯æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...';
                
                // ç”Ÿæˆä»¤ç‰Œ
                const token = generateToken(password);
                
                // é‡å®šå‘
                setTimeout(() => {
                    redirectToProtectedPage(token);
                }, 500);
            } else {
                debugLog('å¯†ç éªŒè¯å¤±è´¥');
                errorDiv.textContent = 'è®¿é—®å¯†é’¥ä¸æ­£ç¡®ï¼Œè¯·é‡è¯•';
                document.getElementById('password').focus();
                document.getElementById('password').select();
                
                // æ·»åŠ æŠ–åŠ¨æ•ˆæœ
                const input = document.getElementById('password');
                input.style.animation = 'none';
                setTimeout(() => {
                    input.style.animation = 'shake 0.5s';
                }, 10);
            }
        });
        
        // æŒ‰Enteré”®æäº¤
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('submitBtn').click();
            }
        });
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                20%, 40%, 60%, 80% { transform: translateX(5px); }
            }
            
            .submit-btn:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
